---
title: "02_DataSelection"
author: "Niklas Jocher"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
```

# Set global chunk options
```{r,}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse) 
```

# 0. Load the CSV
We start by loading the data from the CSV file: we load the csv with the two distractors and save it as a data frame called df_dist2 
```{r,}
data_path <- "/Users/niklasjocher/Desktop/ES data/ga_df_dist2.csv"
df_dist2 <- read_csv(data_path)
```
# 1. Filter for target condition in the time window
```{r,}
t_min <- 0.08
t_max <- 0.2

df_filtered <- df_dist2 %>%
  filter(condition == "target", time >= t_min, time <= t_max)

head(df_filtered)
```

# 2. Plot the filtered data (all subjects, with CI by default)
```{r, fig.align='center'}
ggplot(df_filtered, aes(x = time, y = Amplitude)) +
  geom_line(aes(group = subject_id), alpha = 0.3) +  # individual subjects
  stat_summary(aes(y = Amplitude), fun = mean, geom = "line", color = "blue", size = 1) +
  labs(
    title = "Df_filtered Amplitude for Target Condition (0.12–0.80 s)",
    x = "Time (s)",
    y = "Amplitude"
  ) +
  theme_minimal()
```

# 3. Compute grand average across subjects at each time point
```{r, fig.align='center'}
df_grand_avg <- df_filtered %>%
  group_by(time) %>%
  summarise(Amplitude = mean(Amplitude, na.rm = TRUE)) %>%
  ungroup()

# Plot the grand average
ggplot(df_grand_avg, aes(x = time, y = Amplitude)) +
  geom_line(color = "blue", size = 1) +
  labs(
    title = "Grand Average Amplitude for Target Condition (0.12–0.80 s)",
    x = "Time (s)",
    y = "Amplitude"
  ) +
  theme_minimal()
```

# 4. Paired t-test between target and distractor1
Compute mean amplitude per subject per condition
```{r,}
df_window <- df_dist2 %>%
  filter(condition %in% c("target", "distractor1"), time >= t_min, time <= t_max) %>%
  group_by(subject_id, condition) %>%
  summarise(mean_amplitude = mean(Amplitude, na.rm = TRUE)) %>%
  ungroup()
```

Pivot to wide format: one column per condition
```{r,}
df_pivot <- df_window %>%
  pivot_wider(names_from = condition, values_from = mean_amplitude)
```

Now we can calculate the paired t-test
```{r,}
t_test_result <- t.test(df_pivot$target, df_pivot$distractor1, paired = TRUE)

t_test_result
```

Now we can plot the result as well:
```{r, fig.align='center'}

ggplot(df_window, aes(x = condition, y = mean_amplitude, group = subject_id)) +
  geom_point(aes(color = factor(subject_id)), size = 2, alpha = 0.6) +
  geom_line(alpha = 0.5) +  # connects paired observations
  stat_summary(fun = mean, geom = "point", shape = 18, size = 4, color = "red") + # grand mean
  stat_summary(fun.data = mean_se, geom = "errorbar", width = 0.2, color = "red") +
  labs(
    title = "Mean Amplitude by Condition (Paired t-test)",
    subtitle = paste0("t = ", round(t_test_result$statistic, 2), 
                      ", p = ", signif(t_test_result$p.value, 3)),
    x = "Condition",
    y = "Mean Amplitude"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
